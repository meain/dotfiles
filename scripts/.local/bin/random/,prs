#!/bin/zsh

set -e

repos="$(cat "$HOME/.config/datafiles/prs-repos")"

cache_repos() {
    echo "$repos" | while read -r repo; do
        chainlink log --repo "$repo" >/dev/null 2>&1 &
    done

    wait
}

run_command() {
    action="$1" && shift
    tempfile=$(mktemp)
    echo "$repos" | while read -r repo; do
        output="$(chainlink log --cache-time 5m --all --output markdown "$@" --repo "$repo" 2>/dev/null || true)"
        if [[ -n $output ]]; then
            printf "## %s\n" "$repo"
            echo "$output"
        fi
    done >"$tempfile"

    if cat "$tempfile" | grep -q "."; then

        case "$action" in
        show)
            cat "$tempfile" | sed 's|##|#|' | sed 's|\[\(#.*\)\](.*)\(.*\)|\1\2|'
            sed 's|\ *-|-|' <"$tempfile" | pbcopy
            ,linkify
            ;;
        *)
            cat "$tempfile" | sed 's|##|#|' | sed 's|\[\(#.*\)\](.*)\(.*\)|\1\2|'
            sed 's|\ *-|-|' <"$tempfile" | pbcopy
            ,linkify

            cat "$tempfile" | grep -E '^\s*-' | cut -d'(' -f2 | cut -d')' -f1 | xargs open
            ;;
        esac
    else
        echo "No PRs found"
    fi
}

case "$1" in
r | review)
    run_command "${2:-show}" --reviewer meain --review-status unapproved
    ;;
a | approved)
    run_command "${2:-show}" --author meain --review-status approved
    ;;
p | pending)
    run_command "${2:-show}" --author meain --review-status unapproved
    ;;
h | help | --help | -h)
    echo "Use one of:"
    echo "- [a]pproved: Approved PRs"
    echo "- [p]ending: Pending approvals on others"
    echo "- [r]eview: Review pending on me"
    exit 0
    ;;
*) # Show all with color headings for each seaction
    printf "Fetcing PRs from all repos...\r"
    cache_repos     # cache them first
    printf "\033[K" # clear line

    printf "%sApproved[a]%s\n" "$(tput setaf 3)" "$(tput sgr0)"
    ,prs approved
    printf "\n%sPending Approval[p]%s\n" "$(tput setaf 3)" "$(tput sgr0)"
    ,prs pending
    printf "\n%sTo Review[r]%s\n" "$(tput setaf 3)" "$(tput sgr0)"
    ,prs review
    ;;
esac
