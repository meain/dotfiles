#!/bin/zsh

set -e

repos="$(cat $HOME/.config/datafiles/prs-repos)"

run_command(){
    tempfile=$(mktemp)
    echo $repos | while read -r repo; do
        output="$(chainlink log --all --output markdown "$@" --repo "$repo" 2> /dev/null || true)"
        if [[ -n $output ]]; then
            printf "## %s\n" "$repo"
            echo "$output"
            echo
        fi
    done > $tempfile

    if cat "$tempfile" | grep -q "."; then
        cat $tempfile | sed 's|##|#|' | glow --width 0
         sed 's|\ *-|-|'<$tempfile | pbcopy
        ,linkify
    else
        echo "No PRs found"
    fi
}

case "$1" in
r|review)
    run_command --reviewer meain --review-status unapproved;;
a|approved)
    run_command --author meain --review-status approved;;
p|pending)
    run_command --author meain --review-status unapproved ;;
*)
    echo "Use one of:"
    echo "- [p]ending: Pending approvals on others"
    echo "- [a]pproved: Approved PRs"
    echo "- [r]eview: Review pending on me"
    exit 1
esac
